<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Smart Door Lock</title>

<script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>

<style>
body{
  font-family:Arial;
  background:#111;
  color:#0f0;
  text-align:center;
}
button{
  padding:10px;
  margin:5px;
  font-size:14px;
}
input{
  padding:6px;
  margin:4px;
}
ul{
  list-style:none;
  padding:0;
}
li{
  margin:6px 0;
}
.card{
  border-bottom:1px solid #0f0;
  padding:6px;
}
.log{
  font-size:12px;
  color:#9f9;
}
</style>
</head>

<body>

<h2>üîê Misalif Smart Door</h2>

<p>Status Pintu: <b><span id="status">OFFLINE</span></b></p>

<button onclick="unlockLocal()">üîì Unlock Local</button>
<button onclick="unlockOnline()">üåç Unlock Online</button>

<hr>

<h3>‚ûï Tambah Kartu (Online)</h3>
<input id="newUid" placeholder="UID contoh: 3514CF01" maxlength="8">
<br>
<button onclick="addOnline()">Tambah Kartu Online</button>

<hr>

<h3>üìá Daftar Kartu RFID</h3>
<ul id="cards"></ul>

<hr>

<h3>üìú Log Akses</h3>
<ul id="log"></ul>

<script>
/* ================= DOM ================= */
const statusEl = document.getElementById('status');
const cardsEl  = document.getElementById('cards');
const logEl    = document.getElementById('log');

/* ================= LOCAL (ESP WEB) ================= */
async function refreshLocal(){
  try{
    const s = await fetch('/status');
    const j = await s.json();
    statusEl.innerText = j.door;
  }catch(e){}

  try{
    const r = await fetch('/cards');
    const list = await r.json();

    cardsEl.innerHTML = '';
    list.forEach((uid,i)=>{
      cardsEl.innerHTML += `
        <li class="card">
          ${uid}
          <button onclick="delLocal(${i})">Local</button>
          <button onclick="delOnline(${i})">Online</button>
        </li>`;
    });
  }catch(e){}
}

function unlockLocal(){
  fetch('/unlock',{method:'POST'});
}

function delLocal(i){
  fetch('/delcard',{
    method:'POST',
    headers:{'Content-Type':'application/x-www-form-urlencoded'},
    body:'index='+i
  });
}

/* ================= MQTT ONLINE ================= */
const mqttToken = 'kataloya777';

const client = mqtt.connect(
  'wss://9d75b1855b984a3c81e9da995ba4db3d.s1.eu.hivemq.cloud:8884/mqtt',
  {
    username:'kataloya',
    password:'Jakarta2025',
    clientId:'web-'+Math.random().toString(16).substr(2,8)
  }
);

client.on('connect',()=>{
  client.subscribe('kataloya777/door/status');
  client.subscribe('kataloya777/door/log');
});

client.on('message',(topic,payload)=>{
  const msg = payload.toString();

  if(topic.endsWith('/status')){
    statusEl.innerText = msg;
  }

  if(topic.endsWith('/log')){
    try{
      const d = JSON.parse(msg);
      logEl.innerHTML =
        `<li class="log">
          [${d.t}] UID:${d.uid} | ${d.src} | ${d.res}
        </li>` + logEl.innerHTML;
    }catch(e){}
  }
});

/* ================= MQTT COMMAND ================= */
function unlockOnline(){
  client.publish(
    'kataloya777/door/cmd',
    'UNLOCK|' + mqttToken
  );
}

function delOnline(i){
  client.publish(
    'kataloya777/door/cmd',
    'DELETE|' + i + '|' + mqttToken
  );
}

function addOnline(){
  const uid = document.getElementById('newUid').value.trim().toUpperCase();
  if(uid.length !== 8){
    alert('UID harus 8 karakter HEX');
    return;
  }

  client.publish(
    'kataloya777/door/cmd',
    'ADD|' + uid + '|' + mqttToken
  );

  document.getElementById('newUid').value = '';
}

/* ================= AUTO REFRESH ================= */
setInterval(refreshLocal,1000);
refreshLocal();
</script>

</body>
</html>
