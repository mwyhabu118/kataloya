<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Smart Door Lock</title>
<script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
<style>
body{font-family:Arial;background:#111;color:#0f0;text-align:center}
button{padding:12px;margin:6px;font-size:16px}
input{padding:6px}
</style>
</head>
<body>

<h2>Misalif Smart Door</h2>

<p>Status Pintu: <b><span id="status">---</span></b></p>

<button onclick="unlockLocal()">üîì Unlock Local</button>
<button onclick="unlockOnline()">üåç Unlock Online</button>

<h3>Daftar Kartu</h3>
<ul id="cards"></ul>

<script>
// ========== LOCAL ==========
function refreshLocal(){
 fetch('/status').then(r=>r.json()).then(j=>{
   status.innerText=j.door;
 });
 fetch('/cards').then(r=>r.json()).then(list=>{
   cards.innerHTML='';
   list.forEach((u,i)=>{
     cards.innerHTML+=
       `<li>${u} <button onclick="delLocal(${i})">Hapus</button>
        <button onclick="delOnline(${i})">Online</button></li>`;
   });
 });
}

function unlockLocal(){
 fetch('/unlock',{method:'POST'});
}

function delLocal(i){
 fetch('/delcard',{
  method:'POST',
  headers:{'Content-Type':'application/x-www-form-urlencoded'},
  body:'index='+i
 });
}

// ========== MQTT ==========
const mqttToken = "kataloya777";
const client = mqtt.connect(
 'wss://9d75b1855b984a3c81e9da995ba4db3d.s1.eu.hivemq.cloud:8884/mqtt',{
   username:'kataloya',
   password:'Jakarta2025'
 });

client.on('connect',()=>{
 client.subscribe('kataloya777/door/status');
});

client.on('message',(t,p)=>{
 status.innerText=p.toString();
});

function unlockOnline(){
 client.publish('kataloya777/door/cmd','UNLOCK|'+mqttToken);
}

function delOnline(i){
 client.publish('kataloya777/door/cmd',
   'DELETE|'+i+'|'+mqttToken);
}

setInterval(refreshLocal,1000);
refreshLocal();
</script>

</body>
</html>
